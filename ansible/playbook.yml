---
##adding main ansible playbook with roles and tags
- name: Deploy YOLO Application Stack
  hosts: vagrant_vm
  become: yes
  
  vars_files:
    - group_vars/all.yml
  
  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags:
        - always
        - setup

    - name: Install prerequisite packages
      block:
        - name: Install common utilities
          apt:
            name:
              - curl
              - git
              - wget
              - gnupg
              - lsb-release
              - ca-certificates
              - software-properties-common
              - build-essential
              - python3-pip
            state: present
            update_cache: yes
        
        - name: Install Docker SDK for Python
          pip:
            name:
              - docker
              - docker-compose
            state: present
        
        - name: Create application group
          group:
            name: "{{ app_group }}"
            state: present
        
        - name: Create application user
          user:
            name: "{{ app_user }}"
            group: "{{ app_group }}"
            create_home: yes
            shell: /bin/bash
            state: present
        
        - name: Create project directories
          file:
            path: "{{ item }}"
            state: directory
            owner: "{{ app_user }}"
            group: "{{ app_group }}"
            mode: '0755'
          loop:
            - "{{ project_root }}"
            - "{{ project_root }}/logs"
            - "{{ mongodb_data_dir }}"
      tags:
        - setup
        - prerequisites

  roles:
    - role: docker
      tags:
        - docker
        - infrastructure
    
    - role: mongodb
      tags:
        - mongodb
        - database
        - infrastructure
    
    - role: backend
      tags:
        - backend
        - application
    
    - role: frontend
      tags:
        - frontend
        - application

  post_tasks:
    - name: Verify deployment
      block:
        - name: Check MongoDB container is running
          docker_container_info:
            name: mongo
          register: mongodb_status
        
        - name: Check backend container is running
          docker_container_info:
            name: yolo-backend
          register: backend_status
        
        - name: Check frontend container is running
          docker_container_info:
            name: yolo-client
          register: frontend_status
        
        - name: Verify MongoDB is healthy
          fail:
            msg: "MongoDB container is not running"
          when: not mongodb_status.exists or mongodb_status.container.State.Status != "running"
        
        - name: Verify backend is healthy
          fail:
            msg: "Backend container is not running"
          when: not backend_status.exists or backend_status.container.State.Status != "running"
        
        - name: Verify frontend is healthy
          fail:
            msg: "Frontend container is not running"
          when: not frontend_status.exists or frontend_status.container.State.Status != "running"
        
        - name: Display deployment status
          debug:
            msg:
              - "‚úÖ MongoDB Container: {{ mongodb_status.container.State.Status }}"
              - "‚úÖ Backend Container: {{ backend_status.container.State.Status }}"
              - "‚úÖ Frontend Container: {{ frontend_status.container.State.Status }}"
              - "üåê Frontend URL: http://{{ ansible_host }}:{{ frontend_port }}"
              - "üîå Backend API URL: http://{{ ansible_host }}:{{ backend_port }}"
              - "üóÑÔ∏è  MongoDB URL: mongodb://{{ ansible_host }}:{{ mongodb_port }}"
      
      rescue:
        - name: Display verification error
          debug:
            msg: "Deployment verification failed. Check container logs."
        
        - name: Show running containers
          command: docker ps -a
          register: containers
        
        - name: Print container status
          debug:
            var: containers.stdout_lines
      
      tags:
        - verify
        - always