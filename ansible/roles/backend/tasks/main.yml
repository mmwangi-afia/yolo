##add common role for base system configuration
---
# Deploy Backend Application using Docker
- name: Deploy Backend Application with Docker
  block:
    - name: Clone application from GitHub
      git:
        repo: "{{ github_repo }}"
        dest: "{{ project_root }}"
        version: "{{ github_branch }}"
        force: yes
      become_user: "{{ app_user }}"

    - name: Set ownership of cloned files
      file:
        path: "{{ project_root }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        recurse: yes

    - name: Ensure Docker network exists
      docker_network:
        name: yolo-network
        state: present

    - name: Stop and remove existing backend container
      docker_container:
        name: yolo-backend
        state: absent
      ignore_errors: yes

    - name: Build backend Docker image
      docker_image:
        name: yolo-backend
        build:
          path: "{{ project_root }}/backend"
        source: build
        state: present
        force_source: yes

    - name: Run backend container
      docker_container:
        name: yolo-backend
        image: yolo-backend
        state: started
        restart_policy: unless-stopped
        networks:
          - name: yolo-network
        published_ports:
          - "{{ backend_port }}:5000"
        env:
          MONGODB_URI: "{{ mongodb_uri }}"
          PORT: "5000"
          NODE_ENV: "{{ app_environment }}"
        volumes:
          - "{{ project_root }}/backend/public/images:/app/public/images"

    - name: Wait for backend to be ready
      wait_for:
        port: "{{ backend_port }}"
        delay: 5
        timeout: 60

  rescue:
    - name: Display backend deployment error
      debug:
        msg: "Failed to deploy backend application"

    - name: Show backend container logs
      command: docker logs yolo-backend
      register: backend_logs
      ignore_errors: yes

    - name: Print backend logs
      debug:
        var: backend_logs.stdout_lines

    - name: Fail the playbook
      fail:
        msg: "Backend deployment failed"

  tags:
    - backend
    - deploy
