##add frontend role to deploy ui container
---
# Deploy Frontend Application using Docker
- name: Deploy Frontend Application with Docker
  block:
    - name: Ensure project is cloned (dependency on backend role)
      stat:
        path: "{{ project_root }}/client"
      register: client_dir

    - name: Clone application if not present
      git:
        repo: "{{ github_repo }}"
        dest: "{{ project_root }}"
        version: "{{ github_branch }}"
        force: yes
      become_user: "{{ app_user }}"
      when: not client_dir.stat.exists

    - name: Set ownership of frontend files
      file:
        path: "{{ project_root }}/client"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        recurse: yes

    - name: Ensure Docker network exists
      docker_network:
        name: yolo-network
        state: present

    - name: Stop and remove existing frontend container
      docker_container:
        name: yolo-client
        state: absent
      ignore_errors: yes

    - name: Build frontend Docker image
      docker_image:
        name: yolo-client
        build:
          path: "{{ project_root }}/client"
        source: build
        state: present
        force_source: yes

    - name: Run frontend container
      docker_container:
        name: yolo-client
        image: yolo-client
        state: started
        restart_policy: unless-stopped
        networks:
          - name: yolo-network
        published_ports:
          - "{{ frontend_port }}:80"

    - name: Wait for frontend to be ready
      wait_for:
        port: "{{ frontend_port }}"
        delay: 3
        timeout: 30

  rescue:
    - name: Display frontend deployment error
      debug:
        msg: "Failed to deploy frontend application"

    - name: Show frontend container logs
      command: docker logs yolo-client
      register: frontend_logs
      ignore_errors: yes

    - name: Print frontend logs
      debug:
        var: frontend_logs.stdout_lines

    - name: Fail the playbook
      fail:
        msg: "Frontend deployment failed"

  tags:
    - frontend
    - deploy