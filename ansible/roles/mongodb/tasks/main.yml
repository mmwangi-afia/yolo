##add database role for containerized database
---
- name: Deploy MongoDB Container
  block:
    - name: Create MongoDB data directory
      file:
        path: "{{ mongodb_data_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'

    - name: Create Docker network
      docker_network:
        name: yolo-network
        state: present

    - name: Stop and remove existing MongoDB container
      docker_container:
        name: mongo
        state: absent
      ignore_errors: yes

    - name: Pull MongoDB Docker image
      docker_image:
        name: "mongo:{{ mongodb_version }}"
        source: pull
        state: present

    - name: Run MongoDB container
      docker_container:
        name: mongo
        image: "mongo:{{ mongodb_version }}"
        state: started
        restart_policy: unless-stopped
        networks:
          - name: yolo-network
        published_ports:
          - "{{ mongodb_port }}:27017"
        volumes:
          - "{{ mongodb_data_dir }}:/data/db"
        env:
          MONGO_INITDB_DATABASE: "{{ mongodb_database }}"

    - name: Wait for MongoDB to start
      wait_for:
        port: "{{ mongodb_port }}"
        delay: 5
        timeout: 30

  rescue:
    - name: Display MongoDB deployment error
      debug:
        msg: "Failed to deploy MongoDB container"

    - name: Show MongoDB container logs
      command: docker logs mongo
      register: mongo_logs
      ignore_errors: yes

    - name: Print MongoDB logs
      debug:
        var: mongo_logs.stdout_lines

    - name: Fail the playbook
      fail:
        msg: "MongoDB deployment failed"

  tags:
    - mongodb
    - database
    - deploy